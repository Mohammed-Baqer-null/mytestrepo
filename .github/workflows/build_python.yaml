name: Build Python for Android

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version to build'
        required: true
        default: 'main'
        type: string
      android_api:
        description: 'Android API level'
        required: true
        default: '27'
        type: string
      arch:
        description: 'Architecture to build for'
        required: true
        default: 'arm64-v8a'
        type: choice
        options:
          - arm64-v8a
          - armeabi-v7a
          - x86
          - x86_64
      static_build:
        description: 'Build static Python'
        required: true
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout CPython repository
        uses: actions/checkout@v4
        with:
          repository: python/cpython
          ref: ${{ github.event.inputs.python_version }}
          fetch-depth: 1
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android NDK
        run: |
          echo "y" | sdkmanager "ndk;25.2.9519653"
          echo "NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libffi-dev \
            libssl-dev \
            zlib1g-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            wget curl llvm \
            libncurses5-dev \
            xz-utils tk-dev \
            libxml2-dev \
            libxmlsec1-dev \
            git automake autoconf \
            libtool pkg-config
      
      - name: Prepare Android environment
        run: |
          # Determine host triplet based on architecture
          case "${{ github.event.inputs.arch }}" in
            "arm64-v8a") HOST="aarch64-linux-android" ;;
            "armeabi-v7a") HOST="armv7a-linux-androideabi" ;;
            "x86") HOST="i686-linux-android" ;;
            "x86_64") HOST="x86_64-linux-android" ;;
          esac
          
          # Set environment variables
          echo "HOST=$HOST" >> $GITHUB_ENV
          echo "ARCH=${{ github.event.inputs.arch }}" >> $GITHUB_ENV
          echo "API=${{ github.event.inputs.android_api }}" >> $GITHUB_ENV
          
          cd Android
          if [ -f "android-env.sh" ]; then
            chmod +x android-env.sh
            # Source the script with all necessary variables
            HOST="$HOST" . ./android-env.sh
            echo "Android environment script sourced"
            echo "HOST set to: $HOST"
            echo "NDK path: $NDK_HOME"
          else
            echo "android-env.sh not found!"
            exit 1
          fi
      
      - name: Build Python for Android
        run: |
          cd Android
          
          if [ ! -f "android.py" ]; then
            echo "Error: android.py script not found!"
            ls -la
            exit 1
          fi
          
          # Build command with all required parameters
          #BUILD_OPTS="--host $HOST"
          
          #if ${{ github.event.inputs.static_build }}; then
            #BUILD_OPTS="$BUILD_OPTS --static"
          #fi
          
          echo "Running Android Python builder with options: $BUILD_OPTS"
          echo "Build command: python3 android.py $BUILD_OPTS"
          
          # Run with verbose output
          python3 android.py build $HOST
          
          if [ $? -ne 0 ]; then
            echo "Build failed!"
            exit 1
          fi
          
          # Verify build output
          if [ -d "../cross-build/build" ]; then
            echo "Build artifacts:"
            ls -la ../cross-build/build/
          else
            echo "No build directory created!"
            exit 1
          fi
      
      - name: Package artifacts
        run: |
          mkdir -p python-android-build
          cd Android
          
          if [ -d "build" ]; then
            echo "Copying build artifacts..."
            cp -rv ../cross-build/build/* ../python-android-build/
            echo "Copied artifacts:"
            ls -la ../python-android-build/
          else
            echo "Build directory not found!"
            ls -la
            exit 1
          fi
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-android-${{ github.event.inputs.arch }}-api${{ github.event.inputs.android_api }}
          path: python-android-build/
